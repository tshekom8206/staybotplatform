<div class="page-content">

  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center flex-wrap grid-margin">
    <div>
      <h4 class="page-title">Template Manager</h4>
      <p class="text-muted mb-0">Create and manage AI chatbot response templates with dynamic variables</p>
    </div>
    <div class="d-flex align-items-center flex-wrap text-nowrap" *ngIf="viewMode === 'list'">
      <button type="button"
              class="btn btn-primary"
              (click)="onCreateTemplate()"
              *ngIf="activeTab === 'templates'">
        <i data-feather="plus" featherIcon class="me-2"></i>
        Create New Template
      </button>
    </div>
  </div>

  <!-- Success/Error Messages -->
  <div class="row" *ngIf="success || error">
    <div class="col-12">
      <div class="alert alert-success alert-dismissible fade show" *ngIf="success">
        <i data-feather="check-circle" featherIcon class="me-2"></i>
        {{ success }}
      </div>
      <div class="alert alert-danger alert-dismissible fade show" *ngIf="error">
        <i data-feather="alert-triangle" featherIcon class="me-2"></i>
        {{ error }}
      </div>
    </div>
  </div>

  <!-- Template Editor View -->
  <div *ngIf="viewMode === 'editor'" class="row">
    <div class="col-12">
      <app-template-editor
        [template]="selectedTemplate"
        [variables]="variables"
        [categories]="categories"
        [availableLanguages]="availableLanguages"
        (back)="onBackToList()"
        (saved)="onTemplateSaved()">
      </app-template-editor>
    </div>
  </div>

  <!-- List View -->
  <div *ngIf="viewMode === 'list'" class="row">
    <div class="col-12">
      <div class="card">

        <!-- Tab Navigation -->
        <div class="card-header bg-white border-0 pb-0">
          <ul class="nav nav-pills">
            <li class="nav-item">
              <a class="nav-link d-flex align-items-center"
                 [class.active]="activeTab === 'templates'"
                 (click)="onTabChange('templates')"
                 style="cursor: pointer;">
                <i data-feather="file-text" featherIcon class="me-2"></i>
                <span>Response Templates</span>
                <span class="badge bg-light text-dark ms-2">{{ totalTemplateCount }}</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link d-flex align-items-center"
                 [class.active]="activeTab === 'variables'"
                 (click)="onTabChange('variables')"
                 style="cursor: pointer;">
                <i data-feather="settings" featherIcon class="me-2"></i>
                <span>Template Variables</span>
                <span class="badge bg-light text-dark ms-2">{{ variables.length }}</span>
              </a>
            </li>
          </ul>
        </div>

        <!-- Templates Tab Content -->
        <div class="card-body" *ngIf="activeTab === 'templates'">

          <!-- Search and Filters -->
          <div class="card mb-4">
            <div class="card-body">
              <form [formGroup]="searchForm">
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label">Search Templates</label>
                    <div class="input-group">
                      <span class="input-group-text">
                        <i data-feather="search" featherIcon></i>
                      </span>
                      <input type="text"
                             class="form-control"
                             placeholder="Search by name, content, or category..."
                             formControlName="searchTerm">
                    </div>
                  </div>

                  <div class="col-md-2">
                    <label class="form-label">Category</label>
                    <select class="form-select" formControlName="category">
                      <option value="">All Categories</option>
                      <option *ngFor="let category of categories" [value]="category">
                        {{ category }}
                      </option>
                    </select>
                  </div>

                  <div class="col-md-2">
                    <label class="form-label">Language</label>
                    <select class="form-select" formControlName="language">
                      <option value="">All Languages</option>
                      <option *ngFor="let lang of availableLanguages" [value]="lang.code">
                        {{ lang.name }}
                      </option>
                    </select>
                  </div>

                  <div class="col-md-2">
                    <label class="form-label">Status</label>
                    <div class="form-check form-switch py-2">
                      <input class="form-check-input"
                             type="checkbox"
                             id="showActiveOnly"
                             formControlName="showActiveOnly">
                      <label class="form-check-label" for="showActiveOnly">
                        Active Only
                      </label>
                    </div>
                  </div>

                  <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button type="button"
                            class="btn btn-outline-secondary w-100"
                            (click)="onClearSearch()"
                            [disabled]="!hasFilters">
                      <i data-feather="x" featherIcon class="me-2"></i>
                      Clear Filters
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <!-- Loading State -->
          <div *ngIf="loading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-2">Loading templates...</p>
          </div>

          <!-- Templates Grid -->
          <div *ngIf="!loading">
            <div class="row g-3">
              <div class="col-12" *ngFor="let template of filteredTemplates; trackBy: trackByTemplateId">
                <div class="card">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                      <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                          <code class="bg-primary bg-opacity-10 text-primary px-2 py-1 rounded me-3">
                            {{ template.templateKey }}
                          </code>
                          <span class="badge bg-light text-dark me-2">
                            <i data-feather="folder" featherIcon class="me-1" style="width: 12px; height: 12px;"></i>
                            {{ template.category }}
                          </span>
                          <span class="badge bg-light text-dark">
                            <i data-feather="globe" featherIcon class="me-1" style="width: 12px; height: 12px;"></i>
                            {{ getLanguageName(template.language) }}
                          </span>
                        </div>
                        <div class="template-content bg-light rounded p-3 mb-3">
                          <p class="mb-0">{{ truncateText(template.template, 150) }}</p>
                        </div>
                      </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                      <div class="d-flex align-items-center">
                        <div class="form-check form-switch me-4">
                          <input class="form-check-input"
                                 type="checkbox"
                                 [id]="'status-' + template.id"
                                 [checked]="template.isActive"
                                 (change)="onToggleTemplateStatus(template)">
                          <label class="form-check-label" [for]="'status-' + template.id">
                            <span class="badge" [class.bg-success]="template.isActive" [class.bg-secondary]="!template.isActive">
                              {{ template.isActive ? 'Active' : 'Inactive' }}
                            </span>
                          </label>
                        </div>
                        <div class="me-4">
                          <small class="text-muted">Priority:</small>
                          <span class="badge ms-1" [ngClass]="template.priority <= 3 ? 'bg-success' : template.priority <= 7 ? 'bg-warning' : 'bg-secondary'">
                            {{ template.priority }}
                          </span>
                        </div>
                        <div>
                          <small class="text-muted">
                            <i data-feather="clock" featherIcon class="me-1" style="width: 12px; height: 12px;"></i>
                            {{ template.updatedAt | date:'MMM d, y, h:mm a' }}
                          </small>
                        </div>
                      </div>

                      <div class="btn-group">
                        <button type="button"
                                class="btn btn-outline-primary btn-sm"
                                (click)="onEditTemplate(template)"
                                title="Edit Template">
                          <i data-feather="edit" featherIcon class="me-1"></i>
                          Edit
                        </button>
                        <button type="button"
                                class="btn btn-outline-danger btn-sm"
                                (click)="onDeleteTemplate(template)"
                                title="Delete Template">
                          <i data-feather="trash-2" featherIcon class="me-1"></i>
                          Delete
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Empty State -->
            <div *ngIf="filteredTemplates.length === 0" class="text-center py-5">
              <div class="d-flex flex-column align-items-center">
                <div class="p-4 rounded-circle bg-light mb-4">
                  <i data-feather="file-text" featherIcon class="text-muted" style="width: 64px; height: 64px;"></i>
                </div>
                <h4 class="text-dark mb-2">{{ hasFilters ? 'No templates match your filters' : 'No templates found' }}</h4>
                <p class="text-muted mb-4 fs-6 col-md-6">
                  {{ hasFilters ? 'Try adjusting your search criteria or clearing the filters to see all templates.' : 'Get started by creating your first response template. Templates help your AI chatbot provide consistent, professional responses.' }}
                </p>
                <button type="button"
                        class="btn btn-primary btn-lg px-4 py-2 shadow-sm"
                        (click)="hasFilters ? onClearSearch() : onCreateTemplate()">
                  <i [attr.data-feather]="hasFilters ? 'refresh-cw' : 'plus'" featherIcon class="me-2"></i>
                  {{ hasFilters ? 'Clear Filters' : 'Create Your First Template' }}
                </button>
              </div>
            </div>
          </div>

          <!-- Pagination -->
          <div *ngIf="totalPages > 1" class="d-flex justify-content-between align-items-center mt-4">
            <div class="text-muted">
              Showing {{ (currentPage - 1) * pageSize + 1 }} to
              {{ Math.min(currentPage * pageSize, totalItems) }} of
              {{ totalItems }} templates
            </div>
            <ngb-pagination
              [(page)]="currentPage"
              [pageSize]="pageSize"
              [collectionSize]="totalItems"
              [maxSize]="5"
              [rotate]="true"
              [boundaryLinks]="true"
              (pageChange)="onPageChange($event)">
            </ngb-pagination>
          </div>

        </div>

        <!-- Variables Tab Content -->
        <div class="card-body" *ngIf="activeTab === 'variables'">
          <app-variable-manager
            [variables]="variables"
            [categories]="categories"
            (variablesSaved)="onVariablesSaved()">
          </app-variable-manager>
        </div>

      </div>
    </div>
  </div>

</div>