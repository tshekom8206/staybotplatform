<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h3 class="mb-1">Housekeeping Dashboard</h3>
    <p class="text-muted mb-0">Manage room status, housekeeping tasks, and staff coordination</p>
  </div>
  <div class="d-flex gap-2">
    <div class="btn-group" role="group">
      <input type="radio" class="btn-check" id="viewRooms" [(ngModel)]="viewMode" value="rooms" (change)="applyFilters()">
      <label class="btn btn-outline-secondary btn-sm" for="viewRooms">
        <i data-feather="home" class="icon-xs me-1" appFeatherIcon></i>
        Rooms
      </label>
      <input type="radio" class="btn-check" id="viewTasks" [(ngModel)]="viewMode" value="tasks" (change)="applyFilters()">
      <label class="btn btn-outline-secondary btn-sm" for="viewTasks">
        <i data-feather="list" class="icon-xs me-1" appFeatherIcon></i>
        Tasks
      </label>
    </div>
    <button type="button" class="btn btn-success btn-sm" (click)="openCreateTaskModal()">
      <i data-feather="refresh-cw" class="icon-xs" appFeatherIcon></i>
      Refresh
    </button>
  </div>
</div>

<!-- Housekeeping Statistics -->
<div class="row g-3 mb-4">
  <div class="col-lg-2 col-md-4 col-sm-6">
    <div class="card border-0 bg-light">
      <div class="card-body text-center p-3">
        <div class="mb-2">
          <i data-feather="home" class="text-muted" style="width: 24px; height: 24px;" appFeatherIcon></i>
        </div>
        <h4 class="mb-0">{{ housekeepingStats.totalRooms }}</h4>
        <small class="text-muted">Total Rooms</small>
      </div>
    </div>
  </div>

  <div class="col-lg-2 col-md-4 col-sm-6">
    <div class="card border-0 bg-light">
      <div class="card-body text-center p-3">
        <div class="mb-2">
          <i data-feather="check-circle" class="text-success" style="width: 24px; height: 24px;" appFeatherIcon></i>
        </div>
        <h4 class="mb-0 text-success">{{ housekeepingStats.cleanRooms }}</h4>
        <small class="text-muted">Clean</small>
      </div>
    </div>
  </div>

  <div class="col-lg-2 col-md-4 col-sm-6">
    <div class="card border-0 bg-light">
      <div class="card-body text-center p-3">
        <div class="mb-2">
          <i data-feather="clock" class="text-warning" style="width: 24px; height: 24px;" appFeatherIcon></i>
        </div>
        <h4 class="mb-0 text-warning">{{ housekeepingStats.dirtyRooms }}</h4>
        <small class="text-muted">Pending</small>
      </div>
    </div>
  </div>

  <div class="col-lg-2 col-md-4 col-sm-6">
    <div class="card border-0 bg-light">
      <div class="card-body text-center p-3">
        <div class="mb-2">
          <i data-feather="rotate-cw" class="text-info" style="width: 24px; height: 24px;" appFeatherIcon></i>
        </div>
        <h4 class="mb-0 text-info">{{ housekeepingStats.inProgressRooms }}</h4>
        <small class="text-muted">In Progress</small>
      </div>
    </div>
  </div>

  <div class="col-lg-2 col-md-4 col-sm-6">
    <div class="card border-0 bg-light">
      <div class="card-body text-center p-3">
        <div class="mb-2">
          <i data-feather="check-circle" class="text-success" style="width: 24px; height: 24px;" appFeatherIcon></i>
        </div>
        <h4 class="mb-0 text-success">{{ housekeepingStats.completedTasks || 0 }}</h4>
        <small class="text-muted">Completed</small>
      </div>
    </div>
  </div>

  <div class="col-lg-2 col-md-4 col-sm-6">
    <div class="card border-0 bg-light">
      <div class="card-body text-center p-3">
        <div class="mb-2">
          <i data-feather="trending-up" class="text-primary" style="width: 24px; height: 24px;" appFeatherIcon></i>
        </div>
        <h4 class="mb-0 text-primary">{{ getCompletionRate() }}%</h4>
        <small class="text-muted">Completion Rate</small>
      </div>
    </div>
  </div>
</div>

<!-- Task Progress Overview -->
<div class="card border-0 mb-4" *ngIf="viewMode === 'tasks'">
  <div class="card-body">
    <h5 class="mb-3">TASK PROGRESS OVERVIEW</h5>
    <div class="row align-items-center">
      <div class="col-md-8">
        <div class="progress-container">
          <div class="progress mb-2" style="height: 8px;">
            <div class="progress-bar bg-success" style="width: 25%"></div>
          </div>
          <div class="d-flex justify-content-between text-sm">
            <span class="text-danger">{{ getTaskCountByPriority('Urgent') }} Urgent</span>
            <span class="text-warning">{{ getTaskCountByPriority('High') }} High</span>
            <span class="text-info">{{ getTaskCountByPriority('Medium') }} Medium</span>
            <span class="text-muted">{{ getTaskCountByPriority('Low') }} Low</span>
          </div>
        </div>
      </div>
      <div class="col-md-4 text-end">
        <small class="text-muted">{{ housekeepingStats.completedTasks }} of {{ filteredTasks.length }} completed</small>
      </div>
    </div>
  </div>
</div>

<!-- Filters -->
<div class="card border-0 mb-4">
  <div class="card-body p-3">
    <div class="row g-3 align-items-center">
      <div class="col-md-4">
        <input
          type="text"
          class="form-control"
          placeholder="Search rooms, tasks, or guests..."
          [(ngModel)]="searchTerm"
          (input)="applyFilters()"
        >
      </div>
      <div class="col-md-2" *ngIf="viewMode === 'rooms'">
        <select class="form-select" [(ngModel)]="roomStatusFilter" (change)="applyFilters()">
          <option value="all">All Statuses</option>
          <option value="dirty">Dirty</option>
          <option value="cleaning">Cleaning</option>
          <option value="clean">Clean</option>
        </select>
      </div>
      <div class="col-md-2" *ngIf="viewMode === 'tasks'">
        <select class="form-select" [(ngModel)]="statusFilter" (change)="applyFilters()">
          <option value="all">All Statuses</option>
          <option *ngFor="let status of statuses" [value]="status">{{ status }}</option>
        </select>
      </div>
      <div class="col-md-2">
        <select class="form-select" [(ngModel)]="priorityFilter" (change)="applyFilters()">
          <option value="all">All Priorities</option>
          <option value="Urgent">Urgent</option>
          <option value="High">High</option>
          <option value="Medium">Medium</option>
          <option value="Low">Low</option>
        </select>
      </div>

      <div class="col-md-2" *ngIf="viewMode === 'tasks'">
        <select class="form-select" [(ngModel)]="assigneeFilter" (change)="applyFilters()">
          <option value="all">All Assignment</option>
          <option value="assigned">Assigned</option>
          <option value="unassigned">Unassigned</option>
        </select>
      </div>
      <div class="col-md-2">
        <button
          type="button"
          class="btn btn-outline-secondary w-100"
          (click)="clearFilters()"
          [attr.aria-label]="'Clear all filters'"
        >
          <i data-feather="refresh-cw" class="me-1" style="width: 16px; height: 16px;" appFeatherIcon></i>
          Reset
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Rooms View -->
<div class="row g-3" *ngIf="viewMode === 'rooms' && !loading">
  <div
    class="col-xl-3 col-lg-4 col-md-6 col-12"
    *ngFor="let room of paginatedItems; trackBy: roomTrackBy; let i = index"
  >
    <div
      class="room-card card h-100 fade-in"
      [class.pulse-urgent]="room.priority === 'Urgent'"
      (click)="openRoomDetailModal(room)"
      (keydown.enter)="openRoomDetailModal(room)"
      (keydown.space)="openRoomDetailModal(room)"
      tabindex="0"
      role="button"
      [attr.aria-label]="'Room ' + room.roomNumber + ', Status: ' + room.status + ', Priority: ' + room.priority"
    >
      <div class="card-header" [ngClass]="getRoomStatusClass(room.status)">
        <div class="room-header-content">
          <div>
            <div class="room-number">Room {{ room.roomNumber }}</div>
            <div class="room-status-text">{{ room.status | titlecase }}</div>
          </div>
          <i [attr.data-feather]="getRoomStatusIcon(room.status)" class="feather-icon status-icon" appFeatherIcon></i>
        </div>
      </div>

      <div class="card-body">
        <div class="priority-row">
          <span
            class="priority-badge badge"
            [ngClass]="{
              'priority-urgent': room.priority === 'Urgent',
              'priority-high': room.priority === 'High',
              'priority-medium': room.priority === 'Medium',
              'priority-low': room.priority === 'Low'
            }"
          >
            {{ room.priority }}
          </span>
          <div class="estimated-time" *ngIf="room.estimatedTime && room.estimatedTime > 0">
            <i data-feather="clock" class="feather-icon me-1" appFeatherIcon></i>
            {{ room.estimatedTime }}min
          </div>
        </div>

        <div class="room-info" *ngIf="room.guestName || room.checkOut || room.checkIn">
          <div class="info-item" *ngIf="room.guestName">
            <i data-feather="user" class="feather-icon" appFeatherIcon></i>
            <span>{{ room.guestName }}</span>
          </div>
          <div class="info-item" *ngIf="room.checkOut">
            <i data-feather="log-out" class="feather-icon" appFeatherIcon></i>
            <span>Check-out: {{ room.checkOut | date:'HH:mm' }}</span>
          </div>
          <div class="info-item" *ngIf="room.checkIn">
            <i data-feather="log-in" class="feather-icon" appFeatherIcon></i>
            <span>Check-in: {{ room.checkIn | date:'HH:mm' }}</span>
          </div>
        </div>

        <div class="task-list" *ngIf="room.tasks.length > 0">
          <div class="task-list-header">Tasks ({{ room.tasks.length }})</div>
          <div class="task-items">
            <div class="task-item" *ngFor="let task of room.tasks.slice(0, 3); let i = index">
              <i [attr.data-feather]="getTaskIcon(task.title)" class="feather-icon" appFeatherIcon></i>
              <span class="text-truncate">{{ task.title }}</span>
            </div>
            <div class="task-item" *ngIf="room.tasks.length > 3">
              <i data-feather="more-horizontal" class="feather-icon" appFeatherIcon></i>
              <span>+{{ room.tasks.length - 3 }} more tasks</span>
            </div>
          </div>
        </div>

        <div class="room-notes" *ngIf="room.notes">
          <i data-feather="message-circle" class="feather-icon" appFeatherIcon></i>
          <span>{{ room.notes }}</span>
        </div>
      </div>

      <div class="card-footer">
        <div class="action-buttons" (click)="$event.stopPropagation()">
          <button
            *ngIf="room.status === 'dirty'"
            class="btn btn-info"
            (click)="updateRoomStatus(room, 'cleaning')"
            [attr.aria-label]="'Start cleaning room ' + room.roomNumber"
          >
            <i data-feather="play-circle" class="feather-icon" appFeatherIcon></i>
            Start Cleaning
          </button>
          <button
            *ngIf="room.status === 'cleaning'"
            class="btn btn-warning"
            (click)="updateRoomStatus(room, 'inspecting')"
            [attr.aria-label]="'Mark room ' + room.roomNumber + ' ready for inspection'"
          >
            <i data-feather="eye" class="feather-icon" appFeatherIcon></i>
            Ready for Inspection
          </button>
          <button
            *ngIf="room.status === 'inspecting'"
            class="btn btn-success"
            (click)="updateRoomStatus(room, 'clean')"
            [attr.aria-label]="'Mark room ' + room.roomNumber + ' as clean'"
          >
            <i data-feather="check-circle" class="feather-icon" appFeatherIcon></i>
            Mark Clean
          </button>
          <button
            *ngIf="room.status === 'clean'"
            class="btn btn-outline-secondary disabled"
            disabled
            [attr.aria-label]="'Room ' + room.roomNumber + ' is ready'"
          >
            <i data-feather="check" class="feather-icon" appFeatherIcon></i>
            Room Ready
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Task List - Active Tasks Tab -->
<div *ngIf="viewMode === 'tasks' && !loading">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex gap-2">
      <button class="btn btn-success btn-sm px-3">
        Active Tasks ({{ housekeepingStats.pendingTasks }})
      </button>
      <button class="btn btn-outline-secondary btn-sm px-3">
        All Tasks
      </button>
      <button class="btn btn-outline-secondary btn-sm px-3">
        Completed ({{ housekeepingStats.completedTasks }})
      </button>
    </div>
    <div class="d-flex gap-2">
      <select class="form-select form-select-sm" style="width: auto;">
        <option>All Priorities</option>
        <option>High</option>
        <option>Medium</option>
        <option>Low</option>
      </select>
      <select class="form-select form-select-sm" style="width: auto;">
        <option>All Time</option>
      </select>
    </div>
  </div>

  <!-- Task Cards -->
  <div class="row g-3">
    <div class="col-12" *ngFor="let task of paginatedItems; trackBy: taskTrackBy">
      <div class="card border-0 h-100">
        <div class="card-body p-3">
          <div class="row align-items-center">
            <!-- Task Info -->
            <div class="col-md-3">
              <div class="d-flex align-items-start">
                <div class="me-2">
                  <span class="badge text-white"
                        [ngClass]="{
                          'bg-danger': task.priority === 'Urgent',
                          'bg-warning': task.priority === 'High',
                          'bg-info': task.priority === 'Medium',
                          'bg-secondary': task.priority === 'Low'
                        }">
                    {{ task.priority }}
                  </span>
                </div>
                <div>
                  <h6 class="mb-1">{{ task.title }}</h6>
                  <small class="text-muted">{{ task.department || 'Housekeeping' }}</small><br>
                  <small class="text-muted">{{ task.description || task.title }}</small>
                </div>
              </div>
            </div>

            <!-- Room Info -->
            <div class="col-md-2">
              <div class="d-flex align-items-center">
                <i data-feather="map-pin" class="text-muted me-1" style="width: 16px; height: 16px;" appFeatherIcon></i>
                <span>Room {{ task.roomNumber || 'Unknown' }}</span>
              </div>
            </div>

            <!-- Created Date -->
            <div class="col-md-2">
              <div class="d-flex align-items-center">
                <i data-feather="calendar" class="text-muted me-1" style="width: 16px; height: 16px;" appFeatherIcon></i>
                <span>Created: {{ task.createdAt | date:'MMM dd, HH:mm' }}</span>
              </div>
            </div>

            <!-- Due Date -->
            <div class="col-md-2">
              <div class="d-flex align-items-center">
                <i data-feather="clock" class="text-muted me-1" style="width: 16px; height: 16px;" appFeatherIcon></i>
                <span *ngIf="task.estimatedCompletionTime; else noDue">
                  Due: {{ task.estimatedCompletionTime | date:'MMM dd, HH:mm' }}
                </span>
                <ng-template #noDue>
                  <span class="text-muted">No due date</span>
                </ng-template>
              </div>
              <div *ngIf="task.estimatedCompletionTime" class="d-flex align-items-center mt-1">
                <i data-feather="alert-circle" class="text-warning me-1" style="width: 16px; height: 16px;" appFeatherIcon></i>
                <small class="text-warning">Due today</small>
              </div>
            </div>

            <!-- Assigned To -->
            <div class="col-md-2">
              <div class="d-flex align-items-center" *ngIf="task.assignedTo; else unassigned">
                <i data-feather="user" class="text-muted me-1" style="width: 16px; height: 16px;" appFeatherIcon></i>
                <span>{{ task.assignedTo.userName }}</span>
              </div>
              <ng-template #unassigned>
                <div class="d-flex align-items-center">
                  <i data-feather="user-x" class="text-muted me-1" style="width: 16px; height: 16px;" appFeatherIcon></i>
                  <span class="text-muted">Unassigned</span>
                </div>
              </ng-template>
            </div>

            <!-- Action Button -->
            <div class="col-md-1 text-end">
              <div class="dropdown">
                <button class="btn btn-success btn-sm"
                        *ngIf="task.status === 'Pending'"
                        (click)="openTaskEditModal(task)">
                  <i data-feather="plus" class="me-1" style="width: 16px; height: 16px;" appFeatherIcon></i>
                  Quick Action
                </button>
                <button class="btn btn-info btn-sm"
                        *ngIf="task.status === 'InProgress'"
                        (click)="openTaskEditModal(task)">
                  <i data-feather="check" class="me-1" style="width: 16px; height: 16px;" appFeatherIcon></i>
                  Complete
                </button>
                <button class="btn btn-outline-success btn-sm"
                        *ngIf="task.status === 'Completed'" disabled>
                  <i data-feather="check-circle" class="me-1" style="width: 16px; height: 16px;" appFeatherIcon></i>
                  Done
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Old table view (keeping for reference, can be removed later) -->
<div class="tasks-table-card card slide-up d-none" *ngIf="viewMode === 'tasks' && !loading">
  <div class="table-responsive">
    <table class="table mb-0" role="table">
      <thead>
        <tr>
          <th scope="col" class="task-col">Task</th>
          <th scope="col" class="room-col">Room</th>
          <th scope="col" class="priority-col">Priority</th>
          <th scope="col" class="status-col">Status</th>
          <th scope="col" class="assigned-col">Assigned To</th>
          <th scope="col" class="created-col">Created</th>
          <th scope="col" class="due-col">Due</th>
          <th scope="col" class="actions-col">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let task of paginatedItems; trackBy: taskTrackBy; let i = index" class="fade-in">
          <td class="task-info-cell">
            <div class="d-flex align-items-start">
              <div class="task-icon-wrapper me-2">
                <i [attr.data-feather]="getTaskIcon(task.title)" class="feather-icon" appFeatherIcon></i>
              </div>
              <div class="task-info">
                <div class="task-title">{{ task.title }}</div>
                <div class="task-description text-truncate d-none d-md-block" [title]="task.description">
                  {{ task.description || 'No description provided' }}
                </div>
              </div>
            </div>
          </td>
          <td>
            <span class="badge room-badge">{{ task.roomNumber || 'N/A' }}</span>
          </td>
          <td>
            <span
              class="badge"
              [ngClass]="{
                'priority-urgent': task.priority === 'Urgent',
                'priority-high': task.priority === 'High',
                'priority-medium': task.priority === 'Medium',
                'priority-low': task.priority === 'Low'
              }"
            >
              {{ task.priority }}
            </span>
          </td>
          <td>
            <span
              class="badge"
              [ngClass]="{
                'status-completed': task.status === 'Completed',
                'status-inprogress': task.status === 'InProgress',
                'status-pending': task.status === 'Pending',
                'status-onhold': task.status === 'OnHold'
              }"
            >
              {{ task.status }}
            </span>
          </td>
          <td>
            <div *ngIf="task.assignedTo; else unassigned" class="assigned-user">
              <i data-feather="user" class="feather-icon me-1" appFeatherIcon></i>
              {{ task.assignedTo.userName }}
            </div>
            <ng-template #unassigned>
              <span class="unassigned">
                <i data-feather="user-x" class="feather-icon me-1" appFeatherIcon></i>
                Unassigned
              </span>
            </ng-template>
          </td>
          <td>
            <div class="date-info">
              <i data-feather="calendar" class="feather-icon me-1" appFeatherIcon></i>
              {{ task.createdAt | date:'MMM dd' }}<br>
              <small class="text-muted">{{ task.createdAt | date:'HH:mm' }}</small>
            </div>
          </td>
          <td>
            <div class="date-info" *ngIf="task.estimatedCompletionTime; else noDueDate">
              <i data-feather="clock" class="feather-icon me-1" appFeatherIcon></i>
              {{ task.estimatedCompletionTime | date:'MMM dd' }}<br>
              <small class="text-muted">{{ task.estimatedCompletionTime | date:'HH:mm' }}</small>
            </div>
            <ng-template #noDueDate>
              <span class="text-muted">-</span>
            </ng-template>
          </td>
          <td>
            <div class="dropdown" ngbDropdown>
              <button
                type="button"
                class="btn btn-sm btn-outline-secondary"
                ngbDropdownToggle
                [attr.aria-label]="'Task actions for ' + task.title"
              >
                <i data-feather="more-horizontal" class="feather-icon" appFeatherIcon></i>
              </button>
              <div class="dropdown-menu dropdown-menu-end" ngbDropdownMenu>
                <button type="button" class="dropdown-item" (click)="viewTaskDetails(task)">
                  <i data-feather="eye" class="feather-icon" appFeatherIcon></i>
                  View Details
                </button>
                <button type="button" class="dropdown-item" *ngIf="task.status === 'Pending'" (click)="startTask(task)">
                  <i data-feather="play-circle" class="feather-icon" appFeatherIcon></i>
                  Start Task
                </button>
                <button type="button" class="dropdown-item" *ngIf="task.status === 'InProgress'" (click)="completeTask(task)">
                  <i data-feather="check-circle" class="feather-icon" appFeatherIcon></i>
                  Complete Task
                </button>
                <div class="dropdown-divider" *ngIf="task.guestPhone"></div>
                <button type="button" class="dropdown-item" *ngIf="task.guestPhone" (click)="callGuest(task)">
                  <i data-feather="phone" class="feather-icon" appFeatherIcon></i>
                  Call Guest
                </button>
                <button type="button" class="dropdown-item" *ngIf="task.guestPhone" (click)="sendMessage(task)">
                  <i data-feather="message-square" class="feather-icon" appFeatherIcon></i>
                  Send Message
                </button>
                <div class="dropdown-divider"></div>
                <button type="button" class="dropdown-item" (click)="editTask(task)">
                  <i data-feather="edit-3" class="feather-icon" appFeatherIcon></i>
                  Edit Task
                </button>
              </div>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Mobile Task Cards (shown only on very small screens) -->
  <div class="mobile-task-cards d-block d-sm-none">
    <div class="mobile-task-card" *ngFor="let task of paginatedItems; trackBy: taskTrackBy">
      <div class="task-header">
        <div>
          <div class="fw-bold">{{ task.title }}</div>
          <div class="text-muted small">Room {{ task.roomNumber || 'N/A' }}</div>
        </div>
        <span
          class="badge"
          [ngClass]="{
            'priority-urgent': task.priority === 'Urgent',
            'priority-high': task.priority === 'High',
            'priority-medium': task.priority === 'Medium',
            'priority-low': task.priority === 'Low'
          }"
        >
          {{ task.priority }}
        </span>
      </div>
      <div class="task-details">
        <div><strong>Status:</strong> {{ task.status }}</div>
        <div><strong>Assigned:</strong> {{ task.assignedTo?.userName || 'Unassigned' }}</div>
        <div><strong>Created:</strong> {{ task.createdAt | date:'short' }}</div>
        <div><strong>Due:</strong> {{ task.estimatedCompletionTime | date:'short' || '-' }}</div>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Loading State -->
<div class="loading-container" *ngIf="loading">
  <div class="spinner-border" role="status" aria-hidden="true">
    <span class="visually-hidden">Loading...</span>
  </div>
  <div class="loading-text">Loading housekeeping data...</div>
</div>

<!-- Enhanced Empty State -->
<div class="card" *ngIf="!loading && paginatedItems.length === 0">
  <div class="card-body empty-state">
    <i
      [attr.data-feather]="viewMode === 'rooms' ? 'home' : 'clipboard'"
      class="feather-icon empty-icon"
      appFeatherIcon
    ></i>
    <h5 class="empty-title">No {{ viewMode }} found</h5>
    <p class="empty-message mb-3">
      {{ searchTerm ? 'No ' + viewMode + ' match your search criteria.' : 'No ' + viewMode + ' available at the moment.' }}
    </p>
    <div class="d-flex justify-content-center gap-2" *ngIf="searchTerm || statusFilter !== 'all' || priorityFilter !== 'all'">
      <button type="button" class="btn btn-outline-primary btn-sm" (click)="clearFilters()">
        <i data-feather="refresh-cw" class="feather-icon me-1" appFeatherIcon></i>
        Clear Filters
      </button>
      <button type="button" class="btn btn-primary btn-sm" (click)="openCreateTaskModal()" *ngIf="viewMode === 'tasks'">
        <i data-feather="plus" class="feather-icon me-1" appFeatherIcon></i>
        Create Task
      </button>
    </div>
  </div>
</div>

<!-- Enhanced Pagination -->
<div class="d-flex flex-column flex-sm-row justify-content-between align-items-center mt-4 gap-3" *ngIf="totalItems > pageSize && !loading">
  <div class="text-muted small">
    Showing {{ (currentPage - 1) * pageSize + 1 }} to {{ Math.min(currentPage * pageSize, totalItems) }} of {{ totalItems }} {{ viewMode }}
  </div>
  <ngb-pagination
    [(page)]="currentPage"
    [pageSize]="pageSize"
    [collectionSize]="totalItems"
    [maxSize]="5"
    [rotate]="true"
    [boundaryLinks]="true"
    [size]="'sm'"
    (pageChange)="onPageChange($event)"
    class="mb-0"
  >
  </ngb-pagination>
</div>

<!-- Enhanced Create Task Modal -->
<ng-template #createTaskModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">
      <i data-feather="plus-circle" class="feather-icon me-2" appFeatherIcon></i>
      Create Housekeeping Task
    </h4>
    <button type="button" class="btn-close" (click)="modal.dismiss()" aria-label="Close modal"></button>
  </div>
  <form [formGroup]="createTaskForm" (ngSubmit)="createTask()" novalidate>
    <div class="modal-body">
      <div class="row g-4">
        <div class="col-md-6">
          <label class="form-label" for="taskType" required>Task Type</label>
          <select id="taskType" class="form-select" formControlName="taskType" required>
            <option value="" disabled>Select task type</option>
            <option *ngFor="let type of housekeepingTaskTypes" [value]="type.value">
              {{ type.label }} ({{ type.estimatedTime }}min)
            </option>
          </select>
          <div class="form-text">Choose the type of housekeeping task to be performed.</div>
        </div>

        <div class="col-md-6">
          <label class="form-label" for="roomNumber" required>Room Number</label>
          <input
            id="roomNumber"
            type="text"
            class="form-control"
            formControlName="roomNumber"
            placeholder="e.g., 205, 301A"
            required
          >
          <div class="form-text">Enter the room number where the task should be performed.</div>
        </div>

        <div class="col-12">
          <label class="form-label" for="taskTitle" required>Task Title</label>
          <input
            id="taskTitle"
            type="text"
            class="form-control"
            formControlName="title"
            placeholder="Enter a descriptive task title"
            required
          >
        </div>

        <div class="col-12">
          <label class="form-label" for="taskDescription">Description</label>
          <textarea
            id="taskDescription"
            class="form-control"
            rows="3"
            formControlName="description"
            placeholder="Provide detailed task instructions or special requirements"
          ></textarea>
        </div>

        <div class="col-md-6">
          <label class="form-label" for="taskPriority" required>Priority Level</label>
          <select id="taskPriority" class="form-select" formControlName="priority" required>
            <option value="Low">üîπ Low Priority</option>
            <option value="Medium" selected>üî∏ Medium Priority</option>
            <option value="High">‚ö†Ô∏è High Priority</option>
            <option value="Urgent">üö® Urgent</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label" for="guestName">Guest Name</label>
          <input
            id="guestName"
            type="text"
            class="form-control"
            formControlName="guestName"
            placeholder="Guest name (if applicable)"
          >
          <div class="form-text">Optional: Guest name if task is guest-related.</div>
        </div>

        <div class="col-md-6">
          <label class="form-label" for="assignTo">Assign To</label>
          <select id="assignTo" class="form-select" formControlName="assignedToId">
            <option value="">‚ùì Leave Unassigned</option>
            <option *ngFor="let user of staffUsers" [value]="user.id">
              üë§ {{ user.displayName }}
            </option>
          </select>
          <div class="form-text">Optional: Assign task to a specific staff member.</div>
        </div>

        <div class="col-md-6">
          <label class="form-label" for="dueDateTime">Due Date & Time</label>
          <input
            id="dueDateTime"
            type="datetime-local"
            class="form-control"
            formControlName="estimatedCompletionTime"
          >
          <div class="form-text">Optional: Set a deadline for task completion.</div>
        </div>

        <div class="col-12">
          <label class="form-label" for="taskNotes">Additional Notes</label>
          <textarea
            id="taskNotes"
            class="form-control"
            rows="2"
            formControlName="notes"
            placeholder="Any special instructions, requirements, or important information"
          ></textarea>
        </div>
      </div>

      <!-- Form Validation Messages -->
      <div class="alert alert-danger mt-3" *ngIf="createTaskForm.invalid && createTaskForm.touched">
        <h6 class="alert-heading mb-2">
          <i data-feather="alert-triangle" class="feather-icon me-1" appFeatherIcon></i>
          Please correct the following:
        </h6>
        <ul class="mb-0 ps-3">
          <li *ngIf="createTaskForm.get('taskType')?.errors?.['required']">Task type is required</li>
          <li *ngIf="createTaskForm.get('roomNumber')?.errors?.['required']">Room number is required</li>
          <li *ngIf="createTaskForm.get('title')?.errors?.['required']">Task title is required</li>
          <li *ngIf="createTaskForm.get('title')?.errors?.['minlength']">Task title must be at least 3 characters</li>
        </ul>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-outline-secondary" (click)="modal.dismiss()">
        <i data-feather="x" class="feather-icon me-1" appFeatherIcon></i>
        Cancel
      </button>
      <button
        type="submit"
        class="btn btn-primary"
        [disabled]="createTaskForm.invalid"
        [class.loading]="loading"
      >
        <i data-feather="plus" class="feather-icon me-1" appFeatherIcon></i>
        Create Task
      </button>
    </div>
  </form>
</ng-template>

<!-- Enhanced Room Detail Modal -->
<ng-template #roomDetailModal let-modal>
  <div class="modal-header" *ngIf="selectedRoom" [ngClass]="getRoomStatusClass(selectedRoom.status)">
    <h4 class="modal-title">
      <i [attr.data-feather]="getRoomStatusIcon(selectedRoom.status)" class="feather-icon me-2" appFeatherIcon></i>
      Room {{ selectedRoom.roomNumber }} Details
    </h4>
    <button type="button" class="btn-close" (click)="modal.dismiss()" aria-label="Close modal"></button>
  </div>
  <div class="modal-body" *ngIf="selectedRoom">
    <!-- Room Status Overview -->
    <div class="row g-4 mb-4">
      <div class="col-md-6">
        <div class="card border-0 bg-light h-100">
          <div class="card-body">
            <h6 class="card-title mb-3">
              <i data-feather="info" class="feather-icon me-2" appFeatherIcon></i>
              Room Information
            </h6>
            <div class="info-grid">
              <div class="info-item">
                <label>Status:</label>
                <span class="badge" [ngClass]="getRoomStatusClass(selectedRoom.status).replace('text-white', '').replace('text-dark', '')">
                  {{ selectedRoom.status | titlecase }}
                </span>
              </div>
              <div class="info-item">
                <label>Priority:</label>
                <span
                  class="badge"
                  [ngClass]="{
                    'priority-urgent': selectedRoom.priority === 'Urgent',
                    'priority-high': selectedRoom.priority === 'High',
                    'priority-medium': selectedRoom.priority === 'Medium',
                    'priority-low': selectedRoom.priority === 'Low'
                  }"
                >
                  {{ selectedRoom.priority }}
                </span>
              </div>
              <div class="info-item">
                <label>Estimated Time:</label>
                <span>{{ selectedRoom.estimatedTime || 0 }} minutes</span>
              </div>
              <div class="info-item" *ngIf="selectedRoom.guestName">
                <label>Guest:</label>
                <span>{{ selectedRoom.guestName }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card border-0 bg-light h-100">
          <div class="card-body">
            <h6 class="card-title mb-3">
              <i data-feather="calendar" class="feather-icon me-2" appFeatherIcon></i>
              Check-in/out Times
            </h6>
            <div class="info-grid">
              <div class="info-item" *ngIf="selectedRoom.checkOut">
                <label>
                  <i data-feather="log-out" class="feather-icon me-1" appFeatherIcon></i>
                  Check-out:
                </label>
                <span>{{ selectedRoom.checkOut | date:'MMM dd, yyyy HH:mm' }}</span>
              </div>
              <div class="info-item" *ngIf="selectedRoom.checkIn">
                <label>
                  <i data-feather="log-in" class="feather-icon me-1" appFeatherIcon></i>
                  Check-in:
                </label>
                <span>{{ selectedRoom.checkIn | date:'MMM dd, yyyy HH:mm' }}</span>
              </div>
              <div class="info-item" *ngIf="!selectedRoom.checkOut && !selectedRoom.checkIn">
                <span class="text-muted">No check-in/out times available</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tasks List -->
    <div class="card border-0 bg-light">
      <div class="card-body">
        <h6 class="card-title mb-3">
          <i data-feather="list" class="feather-icon me-2" appFeatherIcon></i>
          Associated Tasks ({{ selectedRoom.tasks.length }})
        </h6>
        <div *ngIf="selectedRoom.tasks.length > 0; else noTasks">
          <div class="task-item-detail" *ngFor="let task of selectedRoom.tasks; let i = index">
            <div class="d-flex align-items-start">
              <div class="task-icon me-3">
                <i [attr.data-feather]="getTaskIcon(task.title)" class="feather-icon" appFeatherIcon></i>
              </div>
              <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-start mb-1">
                  <h6 class="mb-1">{{ task.title }}</h6>
                  <span
                    class="badge"
                    [ngClass]="{
                      'priority-urgent': task.priority === 'Urgent',
                      'priority-high': task.priority === 'High',
                      'priority-medium': task.priority === 'Medium',
                      'priority-low': task.priority === 'Low'
                    }"
                  >
                    {{ task.priority }}
                  </span>
                </div>
                <p class="text-muted small mb-2" *ngIf="task.description">{{ task.description }}</p>
                <div class="d-flex justify-content-between align-items-center">
                  <span
                    class="badge"
                    [ngClass]="{
                      'status-completed': task.status === 'Completed',
                      'status-inprogress': task.status === 'InProgress',
                      'status-pending': task.status === 'Pending',
                      'status-onhold': task.status === 'OnHold'
                    }"
                  >
                    {{ task.status }}
                  </span>
                  <small class="text-muted">
                    <i data-feather="calendar" class="feather-icon me-1" appFeatherIcon></i>
                    {{ task.createdAt | date:'MMM dd, HH:mm' }}
                  </small>
                </div>
              </div>
            </div>
            <hr *ngIf="i < selectedRoom.tasks.length - 1" class="my-3">
          </div>
        </div>
        <ng-template #noTasks>
          <div class="text-center py-4">
            <i data-feather="inbox" class="feather-icon text-muted mb-2" style="width: 48px; height: 48px;" appFeatherIcon></i>
            <p class="text-muted mb-0">No tasks assigned to this room</p>
          </div>
        </ng-template>
      </div>
    </div>

    <!-- Notes Section -->
    <div class="card border-0 bg-light mt-4" *ngIf="selectedRoom.notes">
      <div class="card-body">
        <h6 class="card-title mb-3">
          <i data-feather="message-circle" class="feather-icon me-2" appFeatherIcon></i>
          Notes
        </h6>
        <p class="mb-0">{{ selectedRoom.notes }}</p>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-outline-secondary" (click)="modal.dismiss()">
      <i data-feather="x" class="feather-icon me-1" appFeatherIcon></i>
      Close
    </button>
    <button type="button" class="btn btn-primary" (click)="openCreateTaskModal(); modal.dismiss()">
      <i data-feather="plus" class="feather-icon me-1" appFeatherIcon></i>
      Create Task for Room
    </button>
  </div>
</ng-template>

<!-- Task Details Modal -->
<ng-template #taskDetailsModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title" *ngIf="selectedTask">
      <i [attr.data-feather]="getTaskIcon(selectedTask.title)" class="feather-icon me-2" appFeatherIcon></i>
      {{ selectedTask.title }}
    </h4>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>

  <div class="modal-body" *ngIf="selectedTask">
    <div class="row">
      <!-- Left Column - Task Details -->
      <div class="col-md-8">
        <div class="row mb-3">
          <div class="col-sm-4"><strong>Task ID:</strong></div>
          <div class="col-sm-8">#{{ selectedTask.id }}</div>
        </div>

        <div class="row mb-3">
          <div class="col-sm-4"><strong>Description:</strong></div>
          <div class="col-sm-8">{{ selectedTask.description || 'No description provided' }}</div>
        </div>

        <div class="row mb-3">
          <div class="col-sm-4"><strong>Task Type:</strong></div>
          <div class="col-sm-8">
            <span class="badge bg-light text-dark">{{ selectedTask.title }}</span>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-sm-4"><strong>Department:</strong></div>
          <div class="col-sm-8">{{ selectedTask.department }}</div>
        </div>

        <div class="row mb-3">
          <div class="col-sm-4"><strong>Created:</strong></div>
          <div class="col-sm-8">{{ selectedTask.createdAt | date:'medium' }}</div>
        </div>

        <div class="row mb-3" *ngIf="selectedTask.updatedAt">
          <div class="col-sm-4"><strong>Last Updated:</strong></div>
          <div class="col-sm-8">{{ selectedTask.updatedAt | date:'medium' }}</div>
        </div>

        <div class="row mb-3" *ngIf="selectedTask.estimatedCompletionTime">
          <div class="col-sm-4"><strong>Due Date:</strong></div>
          <div class="col-sm-8">
            {{ selectedTask.estimatedCompletionTime | date:'medium' }}
            <span *ngIf="isOverdue(selectedTask)" class="badge bg-danger ms-2">
              Overdue {{ getOverdueText(selectedTask) }}
            </span>
          </div>
        </div>

        <div class="row mb-3" *ngIf="selectedTask.notes">
          <div class="col-sm-4"><strong>Notes:</strong></div>
          <div class="col-sm-8">{{ selectedTask.notes }}</div>
        </div>
      </div>

      <!-- Right Column - Status & Guest Info -->
      <div class="col-md-4">
        <div class="card">
          <div class="card-body">
            <h6 class="card-title">Status Information</h6>

            <div class="mb-3">
              <label class="form-label">Priority:</label>
              <div>
                <span [class]="getPriorityBadgeClass(selectedTask.priority)">
                  {{ selectedTask.priority }}
                </span>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Status:</label>
              <div>
                <span [class]="getStatusBadgeClass(selectedTask.status)">
                  {{ selectedTask.status }}
                </span>
              </div>
            </div>

            <div class="mb-3" *ngIf="selectedTask.assignedTo">
              <label class="form-label">Assigned To:</label>
              <div>{{ selectedTask.assignedTo.userName }}</div>
            </div>

            <div *ngIf="!selectedTask.assignedTo" class="mb-3">
              <span class="text-muted">Unassigned</span>
            </div>
          </div>
        </div>

        <!-- Guest Information Card -->
        <div class="card mt-3" *ngIf="selectedTask.guestName || selectedTask.guestPhone || selectedTask.roomNumber">
          <div class="card-body">
            <h6 class="card-title">Guest Information</h6>

            <div class="mb-2" *ngIf="selectedTask.guestName">
              <label class="form-label">Guest Name:</label>
              <div>{{ selectedTask.guestName }}</div>
            </div>

            <div class="mb-2" *ngIf="selectedTask.guestPhone">
              <label class="form-label">Phone:</label>
              <div>
                <a href="tel:{{ selectedTask.guestPhone }}" class="text-decoration-none">
                  {{ selectedTask.guestPhone }}
                </a>
                <button class="btn btn-sm btn-outline-secondary ms-2"
                        (click)="callGuest(selectedTask)"
                        title="Copy to clipboard">
                  <i data-feather="copy" class="feather-icon" appFeatherIcon></i>
                </button>
              </div>
            </div>

            <div class="mb-2" *ngIf="selectedTask.roomNumber">
              <label class="form-label">Room:</label>
              <div>
                <span class="badge bg-light text-dark">
                  Room {{ selectedTask.roomNumber }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-footer" *ngIf="selectedTask">
    <button type="button" class="btn btn-secondary" (click)="modal.dismiss()">
      Close
    </button>

    <button type="button"
            class="btn btn-primary"
            *ngIf="selectedTask.status === 'Pending'"
            (click)="startTask(selectedTask); modal.dismiss()">
      <i data-feather="play-circle" class="feather-icon me-1" appFeatherIcon></i>
      Start Task
    </button>

    <button type="button"
            class="btn btn-success"
            *ngIf="selectedTask.status === 'InProgress'"
            (click)="completeTask(selectedTask); modal.dismiss()">
      <i data-feather="check-circle" class="feather-icon me-1" appFeatherIcon></i>
      Complete Task
    </button>

    <button type="button"
            class="btn btn-outline-primary"
            *ngIf="selectedTask.guestPhone"
            (click)="sendMessage(selectedTask)">
      <i data-feather="message-square" class="feather-icon me-1" appFeatherIcon></i>
      Send Message
    </button>
  </div>
</ng-template>

<!-- Task Edit Modal -->
<ng-template #taskEditModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title" *ngIf="selectedTask">
      <i data-feather="edit-2" class="feather-icon me-2" appFeatherIcon></i>
      Quick Action - {{ selectedTask.title }}
    </h4>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>

  <div class="modal-body" *ngIf="selectedTask">
    <form [formGroup]="editTaskForm">
      <!-- Task Information Display -->
      <div class="card mb-3 bg-light">
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-2">
              <small class="text-muted">Room Number:</small>
              <div><strong>{{ selectedTask.roomNumber || 'N/A' }}</strong></div>
            </div>
            <div class="col-md-6 mb-2">
              <small class="text-muted">Task ID:</small>
              <div><strong>#{{ selectedTask.id }}</strong></div>
            </div>
            <div class="col-12 mb-2" *ngIf="selectedTask.guestName">
              <small class="text-muted">Guest Name:</small>
              <div><strong>{{ selectedTask.guestName }}</strong></div>
            </div>
            <div class="col-12" *ngIf="selectedTask.description">
              <small class="text-muted">Description:</small>
              <div>{{ selectedTask.description }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Editable Fields -->
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label" for="editStatus">
            <i data-feather="activity" class="feather-icon me-1" appFeatherIcon></i>
            Status *
          </label>
          <select id="editStatus" class="form-select" formControlName="status" required>
            <option value="Pending">‚è±Ô∏è Pending</option>
            <option value="InProgress">üîÑ In Progress</option>
            <option value="OnHold">‚è∏Ô∏è On Hold</option>
            <option value="Completed">‚úÖ Completed</option>
          </select>
          <div class="form-text">Update the current task status</div>
        </div>

        <div class="col-md-6 mb-3">
          <label class="form-label" for="editPriority">
            <i data-feather="alert-circle" class="feather-icon me-1" appFeatherIcon></i>
            Priority *
          </label>
          <select id="editPriority" class="form-select" formControlName="priority" required>
            <option value="Low">Low</option>
            <option value="Medium">Medium</option>
            <option value="High">High</option>
            <option value="Urgent">üö® Urgent</option>
          </select>
          <div class="form-text">Adjust task priority level</div>
        </div>

        <div class="col-md-6 mb-3">
          <label class="form-label" for="editAssignedTo">
            <i data-feather="user" class="feather-icon me-1" appFeatherIcon></i>
            Assign To
          </label>
          <select id="editAssignedTo" class="form-select" formControlName="assignedToId">
            <option [value]="null">‚ùì Unassigned</option>
            <option *ngFor="let user of staffUsers" [value]="user.id">
              üë§ {{ user.displayName }}
            </option>
          </select>
          <div class="form-text">Reassign task to another staff member</div>
        </div>

        <div class="col-md-6 mb-3">
          <label class="form-label" for="editDueDateTime">
            <i data-feather="clock" class="feather-icon me-1" appFeatherIcon></i>
            Due Date & Time
          </label>
          <input
            id="editDueDateTime"
            type="datetime-local"
            class="form-control"
            formControlName="estimatedCompletionTime"
          >
          <div class="form-text">Update task deadline</div>
        </div>

        <div class="col-12 mb-3">
          <label class="form-label" for="editNotes">
            <i data-feather="file-text" class="feather-icon me-1" appFeatherIcon></i>
            Notes
          </label>
          <textarea
            id="editNotes"
            class="form-control"
            rows="3"
            formControlName="notes"
            placeholder="Add notes, updates, or special instructions..."
          ></textarea>
          <div class="form-text">Add any additional information or updates</div>
        </div>
      </div>

      <!-- Quick Action Buttons -->
      <div class="alert alert-info mb-0" *ngIf="selectedTask.status === 'Pending'">
        <i data-feather="info" class="feather-icon me-1" appFeatherIcon></i>
        <strong>Quick Actions:</strong> Change status to "In Progress" to start working on this task
      </div>
      <div class="alert alert-success mb-0" *ngIf="selectedTask.status === 'InProgress'">
        <i data-feather="check-circle" class="feather-icon me-1" appFeatherIcon></i>
        <strong>Quick Actions:</strong> Change status to "Completed" when the task is finished
      </div>
    </form>
  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-outline-secondary" (click)="modal.dismiss()">
      <i data-feather="x" class="feather-icon me-1" appFeatherIcon></i>
      Cancel
    </button>
    <button
      type="button"
      class="btn btn-primary"
      [disabled]="editTaskForm.invalid"
      (click)="saveTaskEdit()">
      <i data-feather="save" class="feather-icon me-1" appFeatherIcon></i>
      Save Changes
    </button>
  </div>
</ng-template>