<!-- Header Section -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h4 class="fw-bold mb-1">Staff Management</h4>
    <p class="text-muted mb-0">Manage team members and their roles</p>
  </div>
  <button class="btn btn-primary" (click)="openAddStaffModal()">
    <i data-feather="plus" featherIcon class="me-2"></i>
    Add Staff Member
  </button>
</div>

<!-- Alert Messages -->
<div *ngIf="error" class="alert alert-danger alert-dismissible fade show" role="alert">
  {{ error }}
  <button type="button" class="btn-close" (click)="dismissError()"></button>
</div>

<div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show" role="alert">
  {{ successMessage }}
  <button type="button" class="btn-close" (click)="dismissSuccess()"></button>
</div>

<!-- Statistics Cards -->
<div class="row mb-4" *ngIf="stats">
  <div class="col-lg-3 col-sm-6">
    <div class="card h-100">
      <div class="card-body d-flex align-items-center">
        <div class="me-3">
          <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
            <i data-feather="users" featherIcon class="text-white"></i>
          </div>
        </div>
        <div>
          <h4 class="fw-bold mb-0">{{ stats.totalStaff }}</h4>
          <p class="text-muted mb-0">Total Staff</p>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-sm-6">
    <div class="card h-100">
      <div class="card-body d-flex align-items-center">
        <div class="me-3">
          <div class="bg-success rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
            <i data-feather="user-check" featherIcon class="text-white"></i>
          </div>
        </div>
        <div>
          <h4 class="fw-bold mb-0">{{ stats.activeStaff }}</h4>
          <p class="text-muted mb-0">Active Staff</p>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-sm-6">
    <div class="card h-100">
      <div class="card-body d-flex align-items-center">
        <div class="me-3">
          <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
            <i data-feather="user-x" featherIcon class="text-white"></i>
          </div>
        </div>
        <div>
          <h4 class="fw-bold mb-0">{{ stats.inactiveStaff }}</h4>
          <p class="text-muted mb-0">Inactive Staff</p>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-sm-6">
    <div class="card h-100">
      <div class="card-body d-flex align-items-center">
        <div class="me-3">
          <div class="bg-info rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
            <i data-feather="shield" featherIcon class="text-white"></i>
          </div>
        </div>
        <div>
          <h4 class="fw-bold mb-0">{{ availableRoles.length }}</h4>
          <p class="text-muted mb-0">Available Roles</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Filters and Search -->
<div class="card mb-4">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-4">
        <div class="input-group">
          <span class="input-group-text">
            <i data-feather="search" featherIcon></i>
          </span>
          <input
            type="text"
            class="form-control"
            placeholder="Search staff..."
            [(ngModel)]="searchTerm"
            (input)="onSearch()">
        </div>
      </div>

      <div class="col-md-3">
        <select class="form-select" [(ngModel)]="selectedRole" (change)="onFilterChange()">
          <option value="">All Roles</option>
          <option *ngFor="let role of availableRoles" [value]="role.value">{{ role.label }}</option>
        </select>
      </div>

      <div class="col-md-3">
        <select class="form-select" [(ngModel)]="selectedStatus" (change)="onFilterChange()">
          <option value="">All Status</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>
      </div>

      <div class="col-md-2">
        <button class="btn btn-outline-secondary w-100" (click)="clearFilters()">
          <i data-feather="x" featherIcon class="me-1"></i>
          Clear
        </button>
      </div>
    </div>

    <!-- Tab Navigation -->
    <ul class="nav nav-pills mt-3">
      <li class="nav-item">
        <a class="nav-link" [class.active]="activeTab === 'all'" (click)="setActiveTab('all')">
          All Staff ({{ getTotalStaffCount() }})
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" [class.active]="activeTab === 'active'" (click)="setActiveTab('active')">
          Active
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" [class.active]="activeTab === 'inactive'" (click)="setActiveTab('inactive')">
          Inactive
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" [class.active]="activeTab === 'managers'" (click)="setActiveTab('managers')">
          Managers
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" [class.active]="activeTab === 'agents'" (click)="setActiveTab('agents')">
          Agents
        </a>
      </li>
    </ul>
  </div>
</div>

<!-- Loading State -->
<div *ngIf="loading" class="text-center py-5">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
  <p class="mt-3 text-muted">Loading staff members...</p>
</div>

<!-- Staff Members Grid -->
<div *ngIf="!loading" class="row">
  <div class="col-lg-4 col-md-6 mb-4" *ngFor="let staff of filteredStaffMembers">
    <div class="card h-100 staff-card">
      <div class="card-header d-flex justify-content-between align-items-start">
        <div class="d-flex align-items-center">
          <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-3"
               style="width: 40px; height: 40px;">
            <i data-feather="user" featherIcon class="text-muted"></i>
          </div>
          <div>
            <h6 class="mb-1">{{ staff.email }}</h6>
            <span class="badge" [class]="getRoleBadgeClass(staff.role)">{{ staff.role }}</span>
          </div>
        </div>
        <div class="dropdown" ngbDropdown>
          <button class="btn btn-sm btn-outline-secondary" ngbDropdownToggle>
            <i data-feather="more-vertical" featherIcon></i>
          </button>
          <div class="dropdown-menu" ngbDropdownMenu>
            <a class="dropdown-item" (click)="openEditStaffModal(staff)">
              <i data-feather="edit-2" featherIcon class="me-2"></i>
              Edit Details
            </a>
            <a class="dropdown-item" (click)="openPasswordModal(staff)">
              <i data-feather="key" featherIcon class="me-2"></i>
              Change Password
            </a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" (click)="toggleStaffStatus(staff)">
              <i data-feather="user-x" featherIcon class="me-2" *ngIf="staff.isActive"></i>
              <i data-feather="user-check" featherIcon class="me-2" *ngIf="!staff.isActive"></i>
              {{ staff.isActive ? 'Deactivate' : 'Activate' }}
            </a>
            <a class="dropdown-item text-danger" (click)="deleteStaff(staff)">
              <i data-feather="trash-2" featherIcon class="me-2"></i>
              Delete
            </a>
          </div>
        </div>
      </div>

      <div class="card-body">
        <div class="row mb-3">
          <div class="col-6">
            <small class="text-muted d-block">Status</small>
            <span class="badge" [class]="getStatusBadgeClass(staff.isActive)">
              {{ getStatusText(staff.isActive) }}
            </span>
          </div>
          <div class="col-6" *ngIf="staff.phoneNumber">
            <small class="text-muted d-block">Phone</small>
            <small>{{ staff.phoneNumber }}</small>
          </div>
        </div>

        <div class="row">
          <div class="col-6">
            <small class="text-muted d-block">Joined</small>
            <small>{{ formatDate(staff.createdAt) }}</small>
          </div>
          <div class="col-6">
            <small class="text-muted d-block">Role Assigned</small>
            <small>{{ getTimeAgo(staff.roleAssignedAt) }}</small>
          </div>
        </div>
      </div>

      <div class="card-footer bg-transparent">
        <div class="d-flex justify-content-between align-items-center">
          <small class="text-muted">ID: {{ staff.id }}</small>
          <button class="btn btn-sm btn-outline-primary" (click)="openEditStaffModal(staff)">
            <i data-feather="edit" featherIcon class="me-1"></i>
            Edit
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="filteredStaffMembers.length === 0" class="col-12">
    <div class="card">
      <div class="card-body text-center py-5">
        <i data-feather="users" featherIcon class="text-muted mb-3" style="width: 48px; height: 48px;"></i>
        <h5 class="text-muted">No staff members found</h5>
        <p class="text-muted mb-0">
          <span *ngIf="searchTerm || selectedRole || selectedStatus">
            Try adjusting your filters to find the staff members you're looking for.
          </span>
          <span *ngIf="!searchTerm && !selectedRole && !selectedStatus">
            Add your first staff member to get started.
          </span>
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Add/Edit Staff Modal -->
<ng-template #staffModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">{{ isEditing ? 'Edit Staff Member' : 'Add Staff Member' }}</h4>
    <button type="button" class="btn-close" (click)="closeModal()"></button>
  </div>

  <div class="modal-body">
    <form [formGroup]="staffForm" (ngSubmit)="saveStaff()">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Email Address <span class="text-danger">*</span></label>
          <input
            type="email"
            class="form-control"
            formControlName="email"
            [class.is-invalid]="isFieldInvalid('email')"
            placeholder="Enter email address">
          <div class="invalid-feedback" *ngIf="isFieldInvalid('email')">
            {{ getFieldError('email') }}
          </div>
        </div>

        <div class="col-md-6" *ngIf="!isEditing">
          <label class="form-label">Password <span class="text-danger">*</span></label>
          <input
            type="password"
            class="form-control"
            formControlName="password"
            [class.is-invalid]="isFieldInvalid('password')"
            placeholder="Enter password">
          <div class="invalid-feedback" *ngIf="isFieldInvalid('password')">
            {{ getFieldError('password') }}
          </div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Role <span class="text-danger">*</span></label>
          <select
            class="form-select"
            formControlName="role"
            [class.is-invalid]="isFieldInvalid('role')">
            <option *ngFor="let role of availableRoles" [value]="role.value">
              {{ role.label }}
            </option>
          </select>
          <div class="invalid-feedback" *ngIf="isFieldInvalid('role')">
            {{ getFieldError('role') }}
          </div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Phone Number</label>
          <input
            type="tel"
            class="form-control"
            formControlName="phoneNumber"
            placeholder="Enter phone number">
        </div>

        <div class="col-12">
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              formControlName="isActive"
              id="isActive">
            <label class="form-check-label" for="isActive">
              Active (staff member can log in and access the system)
            </label>
          </div>
        </div>

        <!-- Role Description -->
        <div class="col-12" *ngIf="staffForm.get('role')?.value">
          <div class="alert alert-info mb-0">
            <small>
              <strong>{{ staffForm.get('role')?.value }} Role:</strong>
              {{ getRoleDescription(staffForm.get('role')?.value) }}
            </small>
          </div>
        </div>
      </div>
    </form>
  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>
    <button type="button" class="btn btn-primary" (click)="saveStaff()" [disabled]="staffForm.invalid">
      {{ isEditing ? 'Update Staff Member' : 'Add Staff Member' }}
    </button>
  </div>
</ng-template>

<!-- Change Password Modal -->
<ng-template #passwordModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Change Password</h4>
    <button type="button" class="btn-close" (click)="closeModal()"></button>
  </div>

  <div class="modal-body">
    <p>Change password for <strong>{{ editingStaff?.email }}</strong></p>

    <form [formGroup]="passwordForm" (ngSubmit)="changePassword()">
      <div class="mb-3">
        <label class="form-label">New Password <span class="text-danger">*</span></label>
        <input
          type="password"
          class="form-control"
          formControlName="newPassword"
          [class.is-invalid]="isFieldInvalid('newPassword', passwordForm)"
          placeholder="Enter new password">
        <div class="invalid-feedback" *ngIf="isFieldInvalid('newPassword', passwordForm)">
          {{ getFieldError('newPassword', passwordForm) }}
        </div>
        <small class="text-muted">Password must be at least 6 characters long.</small>
      </div>
    </form>
  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>
    <button type="button" class="btn btn-primary" (click)="changePassword()" [disabled]="passwordForm.invalid">
      Change Password
    </button>
  </div>
</ng-template>