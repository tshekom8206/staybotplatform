<div class="page-content">

  <div class="d-flex justify-content-between align-items-center flex-wrap grid-margin">
    <div>
      <h4 class="mb-3 mb-md-0">Send Message</h4>
    </div>
    <div class="d-flex align-items-center flex-wrap text-nowrap">
      <button type="button"
              class="btn btn-outline-secondary btn-icon-text me-2"
              (click)="saveDraftManually()"
              [disabled]="loading">
        <i appFeatherIcon="save"></i> Save Draft
      </button>
      <button type="button"
              class="btn btn-outline-danger btn-icon-text me-2"
              (click)="clearDraft()">
        <i appFeatherIcon="trash-2"></i> Clear
      </button>
      <button type="button"
              class="btn btn-outline-info btn-icon-text me-2"
              (click)="togglePreview()">
        <i appFeatherIcon="eye"></i> {{ previewMode ? 'Edit' : 'Preview' }}
      </button>
    </div>
  </div>

  <!-- Success/Error Messages -->
  <div class="row" *ngIf="success || error">
    <div class="col-12">
      <ngb-alert type="success"
                 *ngIf="success"
                 [dismissible]="false"
                 class="alert-success">
        <i appFeatherIcon="check-circle" class="me-2"></i>
        {{ success }}
      </ngb-alert>
      <ngb-alert type="danger"
                 *ngIf="error"
                 [dismissible]="false"
                 class="alert-danger">
        <i appFeatherIcon="alert-triangle" class="me-2"></i>
        {{ error }}
      </ngb-alert>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8 col-xl-9">
      <!-- Message Compose Card -->
      <div class="card">
        <div class="card-body">
          <form [formGroup]="messageForm" (ngSubmit)="sendMessage()">

            <!-- Message Title -->
            <div class="mb-3">
              <label for="messageTitle" class="form-label">Message Title</label>
              <input type="text"
                     class="form-control"
                     id="messageTitle"
                     formControlName="title"
                     placeholder="Enter message title..."
                     [class.is-invalid]="messageForm.get('title')?.invalid && messageForm.get('title')?.touched">
              <div class="invalid-feedback"
                   *ngIf="messageForm.get('title')?.invalid && messageForm.get('title')?.touched">
                <div *ngIf="messageForm.get('title')?.errors?.['required']">Title is required</div>
                <div *ngIf="messageForm.get('title')?.errors?.['maxlength']">Title must be less than 100 characters</div>
              </div>
            </div>

            <!-- Message Content -->
            <div class="mb-3" *ngIf="!previewMode">
              <label for="messageContent" class="form-label">Message Content</label>
              <quill-editor
                formControlName="content"
                [modules]="quillConfig"
                placeholder="Compose your message to guests..."
                theme="snow"
                [class.is-invalid]="messageForm.get('content')?.invalid && messageForm.get('content')?.touched">
              </quill-editor>
              <div class="invalid-feedback"
                   *ngIf="messageForm.get('content')?.invalid && messageForm.get('content')?.touched">
                <div *ngIf="messageForm.get('content')?.errors?.['required']">Message content is required</div>
                <div *ngIf="messageForm.get('content')?.errors?.['minlength']">Message must be at least 10 characters</div>
              </div>
            </div>

            <!-- Preview Mode -->
            <div class="mb-3" *ngIf="previewMode">
              <label class="form-label">Message Preview</label>
              <div class="border rounded p-3 bg-light min-height-200">
                <div [innerHTML]="previewContent"></div>
              </div>
            </div>

            <!-- Priority Selection -->
            <div class="mb-3">
              <label for="messagePriority" class="form-label">Priority</label>
              <select class="form-select"
                      id="messagePriority"
                      formControlName="priority">
                <option value="low">Low Priority</option>
                <option value="medium">Medium Priority</option>
                <option value="high">High Priority</option>
                <option value="urgent">Urgent</option>
              </select>
            </div>

            <!-- Schedule Option -->
            <div class="mb-3">
              <div class="form-check">
                <input class="form-check-input"
                       type="checkbox"
                       id="scheduleCheck"
                       (change)="scheduleMessage()">
                <label class="form-check-label" for="scheduleCheck">
                  <i appFeatherIcon="clock" class="me-1"></i>
                  Schedule for later
                </label>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-end">
              <button type="button"
                      class="btn btn-outline-secondary me-2"
                      (click)="clearDraft()"
                      [disabled]="loading">
                Cancel
              </button>
              <button type="submit"
                      class="btn btn-success"
                      [disabled]="!isFormValid || loading">
                <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status">
                  <span class="visually-hidden">Loading...</span>
                </span>
                <i appFeatherIcon="send" class="me-1" *ngIf="!loading"></i>
                {{ loading ? 'Sending...' : 'Send Message' }}
              </button>
            </div>

            <!-- Custom Room Selection (moved inside form) -->
            <div class="mb-3">
              <label for="customRooms" class="form-label small">Custom Rooms</label>
              <div class="input-group input-group-sm">
                <input type="text"
                       class="form-control"
                       id="customRooms"
                       formControlName="customRooms"
                       placeholder="101,102,201...">
                <button class="btn btn-outline-primary"
                        type="button"
                        (click)="addCustomRooms()">
                  <i appFeatherIcon="plus"></i>
                </button>
              </div>
              <div class="form-text">
                Enter room numbers separated by commas
              </div>
            </div>

          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-4 col-xl-3">
      <!-- Recipients Panel -->
      <div class="card">
        <div class="card-header">
          <h6 class="card-title mb-0">
            <i appFeatherIcon="users" class="me-2"></i>
            Recipients
          </h6>
        </div>
        <div class="card-body">

          <!-- Selected Recipients -->
          <div class="mb-3" *ngIf="selectedRecipients.length > 0">
            <small class="text-muted d-block mb-2">Selected Recipients ({{ getTotalRecipientCount() }} guests)</small>
            <div class="selected-recipients">
              <div *ngFor="let recipient of selectedRecipients"
                   class="recipient-tag d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                <div class="flex-grow-1">
                  <div class="fw-medium small">{{ recipient.name }}</div>
                  <div class="text-muted small">{{ recipient.count }} guests</div>
                </div>
                <button type="button"
                        class="btn btn-link btn-sm text-danger p-0"
                        (click)="removeRecipient(recipient.id)"
                        ngbTooltip="Remove recipient group">
                  <i appFeatherIcon="x"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Available Recipients -->
          <div class="mb-3">
            <small class="text-muted d-block mb-2">Available Groups</small>
            <div class="list-group list-group-flush">
              <button type="button"
                      *ngFor="let recipient of availableRecipients"
                      class="list-group-item list-group-item-action d-flex justify-content-between align-items-start"
                      (click)="addRecipient(recipient)"
                      [disabled]="isRecipientSelected(recipient)">
                <div class="flex-grow-1">
                  <div class="fw-medium small">{{ recipient.name }}</div>
                  <div class="text-muted small">{{ recipient.description }}</div>
                </div>
                <span class="badge bg-primary rounded-pill">{{ recipient.count }}</span>
              </button>
            </div>
          </div>


          <!-- Send Summary -->
          <div class="mt-3 pt-3 border-top" *ngIf="selectedRecipients.length > 0">
            <div class="d-flex justify-content-between mb-2">
              <small class="text-muted">Total Recipients:</small>
              <small class="fw-bold">{{ getTotalRecipientCount() }}</small>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <small class="text-muted">Priority:</small>
              <span [class]="getPriorityClass(messageForm.get('priority')?.value)" class="small">
                <i [appFeatherIcon]="getPriorityIcon(messageForm.get('priority')?.value)" class="me-1"></i>
                {{ messageForm.get('priority')?.value | titlecase }}
              </span>
            </div>
            <div class="d-flex justify-content-between">
              <small class="text-muted">Delivery:</small>
              <small class="text-success">Immediate</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Message Tips -->
      <div class="card mt-3">
        <div class="card-header">
          <h6 class="card-title mb-0">
            <i appFeatherIcon="info" class="me-2"></i>
            Message Tips
          </h6>
        </div>
        <div class="card-body">
          <ul class="list-unstyled small mb-0">
            <li class="mb-2">
              <i appFeatherIcon="check" class="text-success me-2"></i>
              Keep messages clear and concise
            </li>
            <li class="mb-2">
              <i appFeatherIcon="check" class="text-success me-2"></i>
              Use urgency levels appropriately
            </li>
            <li class="mb-2">
              <i appFeatherIcon="check" class="text-success me-2"></i>
              Preview before sending
            </li>
            <li class="mb-0">
              <i appFeatherIcon="check" class="text-success me-2"></i>
              Save drafts for complex messages
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

</div>