<div class="page-content">

  <div class="d-flex justify-content-between align-items-center flex-wrap grid-margin">
    <div>
      <h4 class="mb-3 mb-md-0">
        <i appFeatherIcon="alert-triangle" class="text-danger me-2"></i>
        Emergency Alert System
      </h4>
    </div>
  </div>

  <!-- Critical Warning -->
  <div class="row" *ngIf="criticalWarning">
    <div class="col-12">
      <div class="alert alert-danger d-flex align-items-center" role="alert">
        <i appFeatherIcon="alert-triangle" featherIcon class="me-2"></i>
        <div>
          <strong>Critical Alert Warning:</strong> This will send an immediate emergency notification to all hotel guests.
          Use only for genuine emergencies.
        </div>
      </div>
    </div>
  </div>

  <!-- Success/Error Messages -->
  <div class="row" *ngIf="success || error">
    <div class="col-12">
      <ngb-alert type="success"
                 *ngIf="success"
                 [dismissible]="false"
                 class="alert-success">
        <i appFeatherIcon="check-circle" featherIcon class="me-2"></i>
        {{ success }}
      </ngb-alert>
      <ngb-alert type="danger"
                 *ngIf="error"
                 [dismissible]="false"
                 class="alert-danger">
        <i appFeatherIcon="alert-triangle" featherIcon class="me-2"></i>
        {{ error }}
      </ngb-alert>
    </div>
  </div>

  <!-- Active Alerts -->
  <div class="row" *ngIf="activeAlerts.length > 0">
    <div class="col-12">
      <div class="card mb-4">
        <div class="card-header bg-danger text-white">
          <h6 class="card-title mb-0">
            <i appFeatherIcon="radio" featherIcon class="me-2"></i>
            Active Emergency Alerts ({{ activeAlerts.length }})
          </h6>
        </div>
        <div class="card-body p-0">
          <div *ngFor="let alert of activeAlerts; trackBy: trackByAlertId"
               class="border-bottom p-3"
               [class.alert-active]="alert.status === 'active'"
               [class.alert-resolved]="alert.status === 'resolved'">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center mb-2">
                  <i [appFeatherIcon]="getTypeConfig(alert.type).icon"
                                         [style.color]="getTypeConfig(alert.type).color"
                     class="me-2"></i>
                  <h6 class="mb-0 me-2">{{ alert.title }}</h6>
                  <span [class]="getSeverityClass(alert.severity)" class="me-2">
                    <i [appFeatherIcon]="getSeverityIcon(alert.severity)" featherIcon class="me-1"></i>
                    {{ alert.severity | titlecase }}
                  </span>
                  <span [class]="getStatusClass(alert.status)">
                    {{ alert.status | titlecase }}
                  </span>
                </div>

                <p class="mb-2">{{ alert.message }}</p>

                <div class="small text-muted mb-2" *ngIf="alert.location">
                  <i appFeatherIcon="map-pin" featherIcon class="me-1"></i>
                  <strong>Location:</strong> {{ alert.location }}
                </div>

                <div class="small text-muted mb-2">
                  <i appFeatherIcon="clock" featherIcon class="me-1"></i>
                  <strong>Sent:</strong> {{ getTimeAgo(alert.createdAt) }}
                  <span class="ms-3" *ngIf="alert.sentCount">
                    <i appFeatherIcon="users" featherIcon class="me-1"></i>
                    {{ alert.sentCount }} recipients
                  </span>
                  <span class="ms-3" *ngIf="alert.acknowledgedCount && alert.requireAcknowledgment">
                    <i appFeatherIcon="check-square" featherIcon class="me-1"></i>
                    {{ alert.acknowledgedCount }}/{{ alert.sentCount }} acknowledged
                    ({{ getAcknowledgmentPercentage(alert) }}%)
                  </span>
                </div>

                <div class="collapse-content mt-3" *ngIf="alert.instructions">
                  <strong class="small">Emergency Instructions:</strong>
                  <div class="small text-muted mt-1"
                       style="white-space: pre-line">{{ alert.instructions }}</div>
                </div>
              </div>

              <div class="ms-3" *ngIf="alert.status === 'active'">
                <div class="btn-group-vertical">
                  <button type="button"
                          class="btn btn-outline-success btn-sm mb-1"
                          (click)="resolveAlert(alert.id!)"
                          ngbTooltip="Mark as resolved">
                    <i appFeatherIcon="check" featherIcon></i>
                  </button>
                  <button type="button"
                          class="btn btn-outline-secondary btn-sm"
                          (click)="cancelAlert(alert.id!)"
                          ngbTooltip="Cancel alert">
                    <i appFeatherIcon="x" featherIcon></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Emergency Alert Form -->
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header bg-danger text-white">
          <h6 class="card-title mb-0">
            <i appFeatherIcon="alert-triangle" featherIcon class="me-2"></i>
            Send Emergency Alert
          </h6>
        </div>
        <div class="card-body">
          <form [formGroup]="emergencyForm" (ngSubmit)="sendEmergencyAlert()">

            <!-- Emergency Type -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="emergencyType" class="form-label">Emergency Type</label>
                <select class="form-select"
                        id="emergencyType"
                        formControlName="type"
                        [class.is-invalid]="emergencyForm.get('type')?.invalid && emergencyForm.get('type')?.touched">
                  <option *ngFor="let type of emergencyTypes"
                          [value]="type.value">
                    {{ type.label }}
                  </option>
                </select>
                <div class="invalid-feedback"
                     *ngIf="emergencyForm.get('type')?.invalid && emergencyForm.get('type')?.touched">
                  Emergency type is required
                </div>
              </div>

              <div class="col-md-6">
                <label for="severity" class="form-label">Severity Level</label>
                <select class="form-select"
                        id="severity"
                        formControlName="severity"
                        [class.is-invalid]="emergencyForm.get('severity')?.invalid && emergencyForm.get('severity')?.touched">
                  <option value="low">Low</option>
                  <option value="medium">Medium</option>
                  <option value="high">High</option>
                  <option value="critical">Critical</option>
                </select>
                <div class="invalid-feedback"
                     *ngIf="emergencyForm.get('severity')?.invalid && emergencyForm.get('severity')?.touched">
                  Severity level is required
                </div>
              </div>
            </div>

            <!-- Alert Title -->
            <div class="mb-3">
              <label for="alertTitle" class="form-label">Alert Title</label>
              <input type="text"
                     class="form-control"
                     id="alertTitle"
                     formControlName="title"
                     placeholder="Enter emergency alert title..."
                     [class.is-invalid]="emergencyForm.get('title')?.invalid && emergencyForm.get('title')?.touched">
              <div class="invalid-feedback"
                   *ngIf="emergencyForm.get('title')?.invalid && emergencyForm.get('title')?.touched">
                <div *ngIf="emergencyForm.get('title')?.errors?.['required']">Title is required</div>
                <div *ngIf="emergencyForm.get('title')?.errors?.['maxlength']">Title must be less than 100 characters</div>
              </div>
            </div>

            <!-- Alert Message -->
            <div class="mb-3">
              <label for="alertMessage" class="form-label">Alert Message</label>
              <textarea class="form-control"
                        id="alertMessage"
                        formControlName="message"
                        rows="3"
                        placeholder="Enter the main emergency message..."
                        [class.is-invalid]="emergencyForm.get('message')?.invalid && emergencyForm.get('message')?.touched"></textarea>
              <div class="invalid-feedback"
                   *ngIf="emergencyForm.get('message')?.invalid && emergencyForm.get('message')?.touched">
                <div *ngIf="emergencyForm.get('message')?.errors?.['required']">Message is required</div>
                <div *ngIf="emergencyForm.get('message')?.errors?.['minlength']">Message must be at least 20 characters</div>
              </div>
            </div>

            <!-- Location (Optional) -->
            <div class="mb-3">
              <label for="location" class="form-label">Location (Optional)</label>
              <input type="text"
                     class="form-control"
                     id="location"
                     formControlName="location"
                     placeholder="e.g., Floor 3 - East Wing">
            </div>

            <!-- Emergency Instructions -->
            <div class="mb-3">
              <label for="instructions" class="form-label">Emergency Instructions</label>
              <textarea class="form-control"
                        id="instructions"
                        formControlName="instructions"
                        rows="4"
                        placeholder="Enter step-by-step instructions for guests..."
                        [class.is-invalid]="emergencyForm.get('instructions')?.invalid && emergencyForm.get('instructions')?.touched"></textarea>
              <div class="invalid-feedback"
                   *ngIf="emergencyForm.get('instructions')?.invalid && emergencyForm.get('instructions')?.touched">
                <div *ngIf="emergencyForm.get('instructions')?.errors?.['required']">Instructions are required</div>
                <div *ngIf="emergencyForm.get('instructions')?.errors?.['minlength']">Instructions must be at least 20 characters</div>
              </div>
            </div>

            <!-- Broadcast Options -->
            <div class="mb-3">
              <div class="form-check mb-2">
                <input class="form-check-input"
                       type="checkbox"
                       id="broadcastAll"
                       formControlName="broadcastAll">
                <label class="form-check-label" for="broadcastAll">
                  Broadcast to all hotel guests
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input"
                       type="checkbox"
                       id="requireAcknowledgment"
                       formControlName="requireAcknowledgment">
                <label class="form-check-label" for="requireAcknowledgment">
                  Require guest acknowledgment
                </label>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-end">
              <button type="button"
                      class="btn btn-outline-secondary me-2"
                      (click)="clearTemplate()"
                      [disabled]="loading">
                Clear Form
              </button>
              <button type="submit"
                      class="btn btn-danger"
                      [disabled]="!isFormValid || loading">
                <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status">
                  <span class="visually-hidden">Loading...</span>
                </span>
                <i appFeatherIcon="radio" featherIcon class="me-1" *ngIf="!loading"></i>
                {{ loading ? 'Sending...' : 'Send Emergency Alert' }}
              </button>
            </div>

          </form>
        </div>
      </div>
    </div>

    <!-- Emergency Templates -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header">
          <h6 class="card-title mb-0">
            <i appFeatherIcon="file-text" featherIcon class="me-2"></i>
            Emergency Templates
          </h6>
        </div>
        <div class="card-body">
          <div class="list-group list-group-flush">
            <button type="button"
                    *ngFor="let template of emergencyTemplates"
                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-start"
                    (click)="applyTemplate(template)"
                    [class.active]="selectedTemplate?.id === template.id">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center mb-1">
                  <i [appFeatherIcon]="getTypeConfig(template.type).icon"
                                         [style.color]="getTypeConfig(template.type).color"
                     class="me-2"></i>
                  <div class="fw-medium small">{{ template.name }}</div>
                </div>
                <div class="text-muted small">{{ getTypeConfig(template.type).label }}</div>
                <span [class]="getSeverityClass(template.severity)" class="mt-1 small">
                  {{ template.severity | titlecase }}
                </span>
              </div>
            </button>
          </div>

          <div class="mt-3 pt-3 border-top" *ngIf="selectedTemplate">
            <div class="small">
              <strong>Selected Template:</strong> {{ selectedTemplate.name }}
            </div>
            <button type="button"
                    class="btn btn-outline-secondary btn-sm mt-2"
                    (click)="clearTemplate()">
              <i appFeatherIcon="x" featherIcon class="me-1"></i>
              Clear Template
            </button>
          </div>
        </div>
      </div>

      <!-- Emergency Guidelines -->
      <div class="card mt-3">
        <div class="card-header">
          <h6 class="card-title mb-0">
            <i appFeatherIcon="info" featherIcon class="me-2"></i>
            Emergency Guidelines
          </h6>
        </div>
        <div class="card-body">
          <ul class="list-unstyled small mb-0">
            <li class="mb-2">
              <i appFeatherIcon="alert-triangle" featherIcon class="text-danger me-2"></i>
              Use only for genuine emergencies
            </li>
            <li class="mb-2">
              <i appFeatherIcon="clock" featherIcon class="text-warning me-2"></i>
              Critical alerts are sent immediately
            </li>
            <li class="mb-2">
              <i appFeatherIcon="users" featherIcon class="text-info me-2"></i>
              All guests receive emergency notifications
            </li>
            <li class="mb-0">
              <i appFeatherIcon="check-square" featherIcon class="text-success me-2"></i>
              Track acknowledgments for safety
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

</div>